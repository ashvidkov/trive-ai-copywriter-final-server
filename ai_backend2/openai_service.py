"""
–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å OpenAI API - –æ–±—Ä–∞–±–æ—Ç–∫–∞ —á–∞–Ω–∫–æ–≤ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ç–∞—Ç–µ–π
"""

import os
import asyncio
from typing import List, Dict, Optional
from dataclasses import dataclass

try:
    from openai import AsyncOpenAI
except ImportError:
    print("‚ö†Ô∏è OpenAI –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: pip install openai")


@dataclass
class GeneratedArticle:
    """–†–µ–∑—É–ª—å—Ç–∞—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å—Ç–∞—Ç—å–∏"""
    title: str
    h1: str
    content: str
    meta_description: str
    keywords: str
    word_count: int
    source_chunks_count: int
    
    def to_dict(self) -> Dict:
        return {
            "title": self.title,
            "h1": self.h1,
            "content": self.content,
            "meta_description": self.meta_description,
            "keywords": self.keywords,
            "word_count": self.word_count,
            "source_chunks_count": self.source_chunks_count
        }


class OpenAIService:
    def __init__(self, api_key: str = None):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è OpenAI —Å–µ—Ä–≤–∏—Å–∞"""
        self.api_key = api_key or os.getenv("OPENAI_API_KEY")
        if not self.api_key:
            raise ValueError("OpenAI API key –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é OPENAI_API_KEY")
        
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞ OpenAI
        try:
            self.client = AsyncOpenAI(api_key=self.api_key)
        except:
            self.client = None
            print("‚ö†Ô∏è OpenAI –∫–ª–∏–µ–Ω—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–∫—É –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ openai")
        
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–¥–µ–ª–∏
        self.model = "gpt-4o"  # –ë–æ–ª–µ–µ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å –¥–ª—è JSON
        self.max_tokens = 2000
        self.temperature = 0.7
        
        # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º gpt-4o –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–ª–∞–Ω–æ–≤
        self.plan_model = "gpt-4o"
        
        # –î–µ—Ñ–æ–ª—Ç–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã
        self.system_prompt = "–¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–ø–∏—Ä–∞–π—Ç–µ—Ä-—Ä–µ—Ä–∞–π—Ç–µ—Ä. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç, —Å–æ—Ö—Ä–∞–Ω–∏–≤ –µ–≥–æ —Å–º—ã—Å–ª –∏ –æ—Å–Ω–æ–≤–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –Ω–æ –∏–∑–º–µ–Ω–∏–≤ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏, —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –∏ —Å—Ç–∏–ª—å –∏–∑–ª–æ–∂–µ–Ω–∏—è."
        self.user_prompt = "–ü–µ—Ä–µ–ø–∏—à–∏ —Å–ª–µ–¥—É—é—â–∏–π —Ç–µ–∫—Å—Ç, —Å–¥–µ–ª–∞–≤ –µ–≥–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã–º, –Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏–≤ –≤—Å—é –≤–∞–∂–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏ —Å–º—ã—Å–ª:"
        
    async def _call_openai(self, messages: List[Dict], temperature: float = None, 
                          max_tokens: int = None, model: str = None) -> str:
        """–í—ã–∑–æ–≤ OpenAI API —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫"""
        if not self.client:
            return "‚ö†Ô∏è OpenAI –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ API –∫–ª—é—á –∏ —É—Å—Ç–∞–Ω–æ–≤–∫—É –±–∏–±–ª–∏–æ—Ç–µ–∫–∏."
            
        try:
            response = await self.client.chat.completions.create(
                model=model or self.model,
                messages=messages,
                max_tokens=max_tokens or self.max_tokens,
                temperature=temperature or self.temperature
            )
            return response.choices[0].message.content.strip()
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ OpenAI API: {str(e)}")
            # –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –¥–∞–ª—å—à–µ –≤–º–µ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—Ç–∞ –¥–µ–º–æ-–¥–∞–Ω–Ω—ã—Ö
            raise e
    

    
    async def process_chunk(self, chunk_content: str, topic: str) -> str:
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–¥–Ω–æ–≥–æ —á–∞–Ω–∫–∞ —Ç–µ–∫—Å—Ç–∞"""
        system_prompt = """–¢—ã - –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–ø–∏—Ä–∞–π—Ç–µ—Ä –∏ —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞.

–¢–≤–æ—è –∑–∞–¥–∞—á–∞: –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç, —Å–¥–µ–ª–∞–≤ –µ–≥–æ:
1. –ü–æ–ª–Ω–æ—Å—Ç—å—é —É–Ω–∏–∫–∞–ª—å–Ω—ã–º (–∏–∑–±–µ–≥–∞–π –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ—Ä–∞–∑)
2. –ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–º –∏ —Ü–µ–Ω–Ω—ã–º –¥–ª—è —á–∏—Ç–∞—Ç–µ–ª—è
3. –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –∏ –ª–æ–≥–∏—á–Ω—ã–º
4. SEO-–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –¥–ª—è –∑–∞–¥–∞–Ω–Ω–æ–π —Ç–µ–º—ã

–°–æ—Ö—Ä–∞–Ω–∏ –≤—Å—é –≤–∞–∂–Ω—É—é —Ç–µ—Ö–Ω–∏—á–µ—Å–∫—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, —Ñ–∞–∫—Ç—ã –∏ –¥–∞–Ω–Ω—ã–µ.
–ò—Å–ø–æ–ª—å–∑—É–π —Å–∏–Ω–æ–Ω–∏–º—ã –∏ –ø–µ—Ä–µ—Ñ—Ä–∞–∑–∏—Ä–æ–≤–∞–Ω–∏–µ.
–î–æ–±–∞–≤—å –ø–µ—Ä–µ—Ö–æ–¥—ã –º–µ–∂–¥—É –∏–¥–µ—è–º–∏ –¥–ª—è –ª—É—á—à–µ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏."""

        user_prompt = f"""–¢–µ–º–∞ —Å—Ç–∞—Ç—å–∏: {topic}

–ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∏:
{chunk_content}

–ü–µ—Ä–µ–ø–∏—à–∏ —ç—Ç–æ—Ç —Ç–µ–∫—Å—Ç, —Å–¥–µ–ª–∞–≤ –µ–≥–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –∏ —É–ª—É—á—à–µ–Ω–Ω—ã–º, —Å–æ—Ö—Ä–∞–Ω–∏–≤ –≤—Å–µ –≤–∞–∂–Ω—ã–µ —Ñ–∞–∫—Ç—ã –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é."""

        messages = [
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": user_prompt}
        ]
        
        return await self._call_openai(messages, temperature=0.8)
    
    async def process_chunk_with_settings(self, chunk_content: str, topic: str, 
                                        system_prompt: str, user_prompt: str,
                                        temperature: float, max_tokens: int, model: str) -> str:
        """
        –û–±—Ä–∞–±–æ—Ç–∫–∞ —á–∞–Ω–∫–∞ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
        """
        messages = [
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": f"{user_prompt}\n\n–¢–µ–º–∞: {topic}\n\n–¢–µ–∫—Å—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏:\n{chunk_content}"}
        ]
        
        return await self._call_openai(messages, temperature=temperature, 
                                      max_tokens=max_tokens, model=model)
    
    async def generate_title(self, content: str, topic: str) -> str:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è SEO-–∑–∞–≥–æ–ª–æ–≤–∫–∞"""
        system_prompt = """–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ SEO –∏ —Å–æ–∑–¥–∞–Ω–∏—é –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤.

–°–æ–∑–¥–∞–π –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–π SEO-–∑–∞–≥–æ–ª–æ–≤–æ–∫ (title) –¥–ª—è —Å—Ç–∞—Ç—å–∏:
- –ú–ê–ö–°–ò–ú–£–ú 255 —Å–∏–º–≤–æ–ª–æ–≤ (—Å—Ç—Ä–æ–≥–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ)
- –î–ª–∏–Ω–∞: 50-60 —Å–∏–º–≤–æ–ª–æ–≤ (–æ–ø—Ç–∏–º–∞–ª—å–Ω–æ)
- –í–∫–ª—é—á–∏ –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
- –°–¥–µ–ª–∞–π –µ–≥–æ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–º –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–º
- –ò–∑–±–µ–≥–∞–π —Å—Ç–æ–ø-—Å–ª–æ–≤ –≤ –Ω–∞—á–∞–ª–µ"""

        user_prompt = f"""–¢–µ–º–∞: {topic}

–ö–æ–Ω—Ç–µ–Ω—Ç —Å—Ç–∞—Ç—å–∏:
{content[:500]}...

–°–æ–∑–¥–∞–π –æ–¥–∏–Ω SEO-–∑–∞–≥–æ–ª–æ–≤–æ–∫ –ú–ê–ö–°–ò–ú–£–ú 255 —Å–∏–º–≤–æ–ª–æ–≤ –±–µ–∑ –∫–∞–≤—ã—á–µ–∫ –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞."""

        messages = [
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": user_prompt}
        ]
        
        return await self._call_openai(messages, temperature=0.6)
    
    async def generate_h1(self, content: str, topic: str) -> str:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è H1 –∑–∞–≥–æ–ª–æ–≤–∫–∞"""
        system_prompt = """–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞.

–°–æ–∑–¥–∞–π H1 –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è —Å—Ç–∞—Ç—å–∏:
- –ú–ê–ö–°–ò–ú–£–ú 255 —Å–∏–º–≤–æ–ª–æ–≤ (—Å—Ç—Ä–æ–≥–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ)
- –û—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç title
- 40-50 —Å–∏–º–≤–æ–ª–æ–≤ (–æ–ø—Ç–∏–º–∞–ª—å–Ω–æ)
- –ß–µ—Ç–∫–æ –æ—Ç—Ä–∞–∂–∞–µ—Ç —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ
- –í–∫–ª—é—á–∞–µ—Ç –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞"""

        user_prompt = f"""–¢–µ–º–∞: {topic}

–ö–æ–Ω—Ç–µ–Ω—Ç —Å—Ç–∞—Ç—å–∏:
{content[:500]}...

–°–æ–∑–¥–∞–π H1 –∑–∞–≥–æ–ª–æ–≤–æ–∫ –ú–ê–ö–°–ò–ú–£–ú 255 —Å–∏–º–≤–æ–ª–æ–≤ –±–µ–∑ –∫–∞–≤—ã—á–µ–∫ –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞."""

        messages = [
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": user_prompt}
        ]
        
        return await self._call_openai(messages, temperature=0.6)
    
    async def generate_meta_description(self, content: str, topic: str) -> str:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–µ—Ç–∞-–æ–ø–∏—Å–∞–Ω–∏—è"""
        system_prompt = """–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ SEO –∏ –º–µ—Ç–∞-–æ–ø–∏—Å–∞–Ω–∏—è–º.

–°–æ–∑–¥–∞–π –º–µ—Ç–∞-–æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è —Å—Ç–∞—Ç—å–∏:
- –ú–ê–ö–°–ò–ú–£–ú 255 —Å–∏–º–≤–æ–ª–æ–≤ (—Å—Ç—Ä–æ–≥–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ)
- –î–ª–∏–Ω–∞: 150-160 —Å–∏–º–≤–æ–ª–æ–≤ (–æ–ø—Ç–∏–º–∞–ª—å–Ω–æ)
- –í–∫–ª—é—á–∏ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
- –ü—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é
- –ö—Ä–∞—Ç–∫–æ –æ–ø–∏—à–∏ —Ü–µ–Ω–Ω–æ—Å—Ç—å —Å—Ç–∞—Ç—å–∏"""

        user_prompt = f"""–¢–µ–º–∞: {topic}

–ö–æ–Ω—Ç–µ–Ω—Ç —Å—Ç–∞—Ç—å–∏:
{content[:800]}...

–°–æ–∑–¥–∞–π –º–µ—Ç–∞-–æ–ø–∏—Å–∞–Ω–∏–µ –ú–ê–ö–°–ò–ú–£–ú 255 —Å–∏–º–≤–æ–ª–æ–≤ –±–µ–∑ –∫–∞–≤—ã—á–µ–∫ –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞."""

        messages = [
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": user_prompt}
        ]
        
        return await self._call_openai(messages, temperature=0.5)
    
    async def generate_keywords(self, content: str, topic: str) -> str:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤"""
        system_prompt = """–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ SEO –∏ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º.

–ù–∞–π–¥–∏ –∏ —Å—Ñ–æ—Ä–º–∏—Ä—É–π —Å–ø–∏—Å–æ–∫ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –¥–ª—è —Å—Ç–∞—Ç—å–∏:
- –ú–ê–ö–°–ò–ú–£–ú 255 —Å–∏–º–≤–æ–ª–æ–≤ (—Å—Ç—Ä–æ–≥–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ)
- 8-12 –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤/—Ñ—Ä–∞–∑
- –†–∞–∑–Ω–æ–π –¥–ª–∏–Ω—ã (1-4 —Å–ª–æ–≤–∞)
- –†–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—é
- –ü–µ—Ä–µ—á–∏—Å–ª–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é"""

        user_prompt = f"""–¢–µ–º–∞: {topic}

–ö–æ–Ω—Ç–µ–Ω—Ç —Å—Ç–∞—Ç—å–∏:
{content[:1000]}...

–°–æ–∑–¥–∞–π —Å–ø–∏—Å–æ–∫ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –ú–ê–ö–°–ò–ú–£–ú 255 —Å–∏–º–≤–æ–ª–æ–≤ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é."""

        messages = [
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": user_prompt}
        ]
        
        return await self._call_openai(messages, temperature=0.4)

    async def embed_chunk(self, chunk_text: str) -> List[float]:
        """–í–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–∞–Ω–∫–∞ —Ç–µ–∫—Å—Ç–∞"""
        try:
            response = await self.client.embeddings.create(
                model="text-embedding-3-small",
                input=chunk_text
            )
            return response.data[0].embedding
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: {str(e)}")
            raise e

    async def summarize_with_priority(self, chunk_text: str, priority: str) -> str:
        """–°—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è —á–∞–Ω–∫–∞ —Å —É—á–µ—Ç–æ–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ (—ç—Ç–∞–ª–æ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∏–∑ Jupyter Notebook)"""
        
        print(f"üìù –°—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è —á–∞–Ω–∫–∞ —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º: {priority}")
        
        # –ü—Ä–æ–º–ø—Ç—ã –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É (—Ç–æ—á–Ω–æ –∫–∞–∫ –≤ Jupyter Notebook)
        PROMPTS = {
            "–≤—ã—Å–æ–∫–∏–π": (
                "gpt-4o",
                "–ü—Ä–æ—á–∏—Ç–∞–π —Ç–µ–∫—Å—Ç –∏ —Å–¥–µ–ª–∞–π –ø–æ–¥—Ä–æ–±–Ω–æ–µ —Ä–µ–∑—é–º–µ (3‚Äì4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è) —Å –∞–∫—Ü–µ–Ω—Ç–æ–º –Ω–∞ —Ñ–∞–∫—Ç—ã, —Ç–µ—Ä–º–∏–Ω—ã –∏ —Å—É—Ç—å:\n\n{text}",
                300
            ),
            "—Å—Ä–µ–¥–Ω–∏–π": (
                "gpt-4o-mini",
                "–°–¥–µ–ª–∞–π –∫—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ —Ç–µ–∫—Å—Ç–∞ –≤ 2‚Äì3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è—Ö, –≤—ã–¥–µ–ª–∏ –æ—Å–Ω–æ–≤–Ω—É—é –º—ã—Å–ª—å –±–µ–∑ –ª–∏—à–Ω–∏—Ö –¥–µ—Ç–∞–ª–µ–π:\n\n{text}",
                200
            ),
            "–Ω–∏–∑–∫–∏–π": (
                "gpt-3.5-turbo",
                "–í—ã–¥–µ–ª–∏ –æ–¥–Ω—É –∫–ª—é—á–µ–≤—É—é –º—ã—Å–ª—å –∏–∑ —Ç–µ–∫—Å—Ç–∞. –û–¥–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:\n\n{text}",
                100
            )
        }
        
        # –ü–æ–ª—É—á–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞
        model, prompt_template, max_tokens = PROMPTS.get(priority, ("gpt-3.5-turbo", "–ö—Ä–∞—Ç–∫–æ –ø–µ—Ä–µ—Å–∫–∞–∂–∏:\n\n{text}", 100))
        
        print(f"  üîß –ú–æ–¥–µ–ª—å: {model}, max_tokens: {max_tokens}")
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç
        prompt = prompt_template.replace("{text}", chunk_text)
        
        # –í—ã–∑—ã–≤–∞–µ–º OpenAI (—Ç–æ—á–Ω–æ –∫–∞–∫ –≤ —ç—Ç–∞–ª–æ–Ω–Ω–æ–π –ª–æ–≥–∏–∫–µ)
        response = await self._call_openai(
            messages=[{"role": "user", "content": prompt}],
            temperature=0.3,
            max_tokens=max_tokens,
            model=model
        )
        
        result = response.strip()
        print(f"  ‚úÖ –°—É–º–º–∞—Ä–∏—è: {result[:100]}...")
        
        return result

    async def generate_article_plan_from_summaries(self, chunk_info: List[Dict]) -> str:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–ª–∞–Ω–∞ —Å—Ç–∞—Ç—å–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—É–º–º–∞—Ä–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —á–∞–Ω–∫–æ–≤ (—ç—Ç–∞–ª–æ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∏–∑ Jupyter Notebook)"""
        
        print(f"ü§ñ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–ª–∞–Ω–∞ —Å—Ç–∞—Ç—å–∏ –∏–∑ {len(chunk_info)} —Å—É–º–º–∞—Ä–∏–π")
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ —Å—É–º–º–∞—Ä–∏–π —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º–∏ (—Ç–æ—á–Ω–æ –∫–∞–∫ –≤ —ç—Ç–∞–ª–æ–Ω–Ω–æ–π –ª–æ–≥–∏–∫–µ)
        summaries = [
            f"[{chunk['priority'].upper()}] {chunk['summary']}"
            for chunk in chunk_info
            if chunk.get("priority") not in [None, "–∏—Å–∫–ª—é—á–∏—Ç—å"] and chunk.get("summary")
        ]

        print(f"üìã –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Å—É–º–º–∞—Ä–∏–π: {len(summaries)}")
        for i, summary in enumerate(summaries[:3]):  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 3 –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
            print(f"  {i+1}. {summary[:100]}...")

        joined = "\n".join(f"- {s}" for s in summaries)

        # –ü—Ä–æ–º–ø—Ç —Ç–æ—á–Ω–æ –∫–∞–∫ –≤ —ç—Ç–∞–ª–æ–Ω–Ω–æ–π –ª–æ–≥–∏–∫–µ
        prompt = f"""
–£ —Ç–µ–±—è –µ—Å—Ç—å —Å–º—ã—Å–ª–æ–≤—ã–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã, –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –∏–∑ —Ä–∞–∑–Ω—ã—Ö —á–∞—Å—Ç–µ–π –±–æ–ª—å—à–æ–≥–æ —Ç–µ–∫—Å—Ç–∞. –£ –∫–∞–∂–¥–æ–≥–æ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞ —É–∫–∞–∑–∞–Ω –µ–≥–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –≤–∞–∂–Ω–æ—Å—Ç–∏.

–°–æ—Å—Ç–∞–≤—å –ª–æ–≥–∏—á–µ—Å–∫–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–ª–∞–Ω —Å—Ç–∞—Ç—å–∏, —Å–æ–±–ª—é–¥–∞—è —Ç–∞–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞:
‚Äî –ë–ª–æ–∫–∏ —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º –í–´–°–û–ö–ò–ô —Å—á–∏—Ç–∞—é—Ç—Å—è –≥–ª–∞–≤–Ω—ã–º–∏. –û–Ω–∏ –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç –æ—Å–Ω–æ–≤–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã —Å—Ç–∞—Ç—å–∏.
‚Äî –ë–ª–æ–∫–∏ —Å–æ –°–†–ï–î–ù–ò–ú –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∫–∞–∫ –ø–æ–¥–±–ª–æ–∫–∏ –∏–ª–∏ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è.
‚Äî –ë–ª–æ–∫–∏ —Å –ù–ò–ó–ö–ò–ú –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º –º–æ–∂–µ—à—å –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å –≤ –æ–±—â–∏–π —Ä–∞–∑–¥–µ–ª –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫—Ä–∞—Ç–∫–æ –≤ –ø–æ—è—Å–Ω–µ–Ω–∏—è—Ö, –Ω–æ –Ω–µ –≤—ã–Ω–æ—Å–∏—Ç—å –≤ –æ—Å–Ω–æ–≤—É —Å—Ç—Ä—É–∫—Ç—É—Ä—ã.
‚Äî –ù–ï –¥–æ–±–∞–≤–ª—è–π –Ω–∏—á–µ–≥–æ –æ—Ç —Å–µ–±—è ‚Äî —Ç–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ —è–≤–Ω–æ –µ—Å—Ç—å –≤ —Å–º—ã—Å–ª–æ–≤—ã—Ö —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞—Ö.
‚Äî –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —Ñ–æ—Ä–º–∞–ª—å–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –≤—Ä–æ–¥–µ "–í–≤–µ–¥–µ–Ω–∏–µ", "–ó–∞–∫–ª—é—á–µ–Ω–∏–µ", –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ.

–í–æ—Ç —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã:
{joined}

–°—Ñ–æ—Ä–º–∏—Ä—É–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–ª–∞–Ω —Å—Ç–∞—Ç—å–∏:
"""

        print("üîÑ –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –ø–ª–∞–Ω–∞...")
        
        # –í—ã–∑–æ–≤ —Ç–æ—á–Ω–æ –∫–∞–∫ –≤ —ç—Ç–∞–ª–æ–Ω–Ω–æ–π –ª–æ–≥–∏–∫–µ
        response = await self._call_openai(
            messages=[{"role": "user", "content": prompt}],
            temperature=0.3,
            max_tokens=1000,
            model="gpt-4o"
        )
        
        result = response.strip()
        print(f"‚úÖ –ü–ª–∞–Ω —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω: {len(result)} —Å–∏–º–≤–æ–ª–æ–≤")
        print(f"üìÑ –ù–∞—á–∞–ª–æ –ø–ª–∞–Ω–∞: {result[:200]}...")
        
        return result
    
    async def generate_article_plan(self, chunks_text: str, topic: str = "—Å—Ç–∞—Ç—å—è",
                                  system_prompt: str = None,
                                  user_prompt: str = None,
                                  temperature: float = None,
                                  max_tokens: int = None,
                                  model: str = None) -> dict:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–ª–∞–Ω —Å—Ç–∞—Ç—å–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —á–∞–Ω–∫–æ–≤"""
        print(f"ü§ñ –ù–∞—á–∏–Ω–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –ø–ª–∞–Ω–∞ –¥–ª—è —Ç–µ–º—ã: {topic}")
        print(f"üìä –î–ª–∏–Ω–∞ —Ç–µ–∫—Å—Ç–∞ —á–∞–Ω–∫–æ–≤: {len(chunks_text)} —Å–∏–º–≤–æ–ª–æ–≤")
        print(f"üîß –ú–æ–¥–µ–ª—å: {model or self.model}")
        print(f"üå°Ô∏è –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: {temperature or self.temperature}")
        
        system_prompt = system_prompt or """–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∞–Ω–∞–ª–∏–∑—É —Ç–µ–∫—Å—Ç–∞. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ü–†–û–ß–ò–¢–ê–¢–¨ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã –∏ —Å–æ–∑–¥–∞—Ç—å –ø–ª–∞–Ω —Å—Ç–∞—Ç—å–∏.

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –¢—ã –î–û–õ–ñ–ï–ù –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∫–∞–∂–¥—ã–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç –∏ —Å–æ–∑–¥–∞—Ç—å –ø–ª–∞–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ –†–ï–ê–õ–¨–ù–û–ì–û —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ.

–ó–ê–ü–†–ï–©–ï–ù–û –ö–ê–¢–ï–ì–û–†–ò–ß–ï–°–ö–ò:
‚ùå "–í–≤–µ–¥–µ–Ω–∏–µ", "–û—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç—å", "–ó–∞–∫–ª—é—á–µ–Ω–∏–µ"
‚ùå "–û—Å–Ω–æ–≤—ã —Ç–µ–º—ã", "–ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–π —Å–∏—Ç—É–∞—Ü–∏–∏"
‚ùå "–ú–µ—Ç–æ–¥—ã –∏ –ø–æ–¥—Ö–æ–¥—ã", "–ö–ª—é—á–µ–≤—ã–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è"
‚ùå –õ—é–±—ã–µ —à–∞–±–ª–æ–Ω–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏

–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û:
1. –ü–†–û–ß–ò–¢–ê–¢–¨ –∫–∞–∂–¥—ã–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ
2. –í–´–Ø–í–ò–¢–¨ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ç–µ–º—ã –≤ —Ç–µ–∫—Å—Ç–µ
3. –°–û–ó–î–ê–¢–¨ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –†–ï–ê–õ–¨–ù–û–ì–û —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
4. –£–ö–ê–ó–ê–¢–¨ –Ω–æ–º–µ—Ä–∞ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞

–ü–†–ò–ú–ï–†–´ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –¥–ª—è —Ç–µ–º—ã "—Ö–æ–ª–æ–¥–Ω–∞—è –≤—ã—Å–∞–¥–∫–∞":
‚úÖ "–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è —Ö–æ–ª–æ–¥–Ω–æ–π –≤—ã—Å–∞–¥–∫–∏ –º–µ—Ç–∏–∑–æ–≤"
‚úÖ "–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –¥–ª—è —Ö–æ–ª–æ–¥–Ω–æ–π –≤—ã—Å–∞–¥–∫–∏"
‚úÖ "–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ö–æ–ª–æ–¥–Ω–æ–π –≤—ã—Å–∞–¥–∫–∏"
‚úÖ "–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≤ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ –∫—Ä–µ–ø–µ–∂–∞"
‚úÖ "–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –≥–æ—Ä—è—á–µ–π —à—Ç–∞–º–ø–æ–≤–∫–æ–π"

–ï—Å–ª–∏ —Ç—ã –Ω–µ –º–æ–∂–µ—à—å –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ, —Å–∫–∞–∂–∏ –æ–± —ç—Ç–æ–º –ø—Ä—è–º–æ."""

        user_prompt = user_prompt or f"""–ê–ù–ê–õ–ò–ó–ò–†–£–ô —Å–ª–µ–¥—É—é—â–∏–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã –∏ —Å–æ–∑–¥–∞–π –ø–ª–∞–Ω —Å—Ç–∞—Ç—å–∏.

–¢–µ–º–∞: {topic}

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –¢—ã –î–û–õ–ñ–ï–ù –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∫–∞–∂–¥—ã–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç –∏ —Å–æ–∑–¥–∞—Ç—å –ø–ª–∞–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ –†–ï–ê–õ–¨–ù–û–ì–û —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ.

–ó–ê–ü–†–ï–©–ï–ù–û –ö–ê–¢–ï–ì–û–†–ò–ß–ï–°–ö–ò:
‚ùå "–í–≤–µ–¥–µ–Ω–∏–µ", "–û—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç—å", "–ó–∞–∫–ª—é—á–µ–Ω–∏–µ"
‚ùå "–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç", "–¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–µ –æ—Å–Ω–æ–≤—ã"
‚ùå "–ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–π —Å–∏—Ç—É–∞—Ü–∏–∏", "–ú–µ—Ç–æ–¥—ã –∏ –ø–æ–¥—Ö–æ–¥—ã"

–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û:
1. –ü–†–û–ß–ò–¢–ê–¢–¨ –∫–∞–∂–¥—ã–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ
2. –í–´–Ø–í–ò–¢–¨ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ç–µ–º—ã –≤ —Ç–µ–∫—Å—Ç–µ
3. –°–û–ó–î–ê–¢–¨ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –†–ï–ê–õ–¨–ù–û–ì–û —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
4. –£–ö–ê–ó–ê–¢–¨ –Ω–æ–º–µ—Ä–∞ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞

–¢–µ–∫—Å—Ç–æ–≤—ã–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã:
{chunks_text}

–ü–†–ò–ú–ï–†–´ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –¥–ª—è —Ç–µ–º—ã "—Ö–æ–ª–æ–¥–Ω–∞—è –≤—ã—Å–∞–¥–∫–∞":
‚úÖ "–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è —Ö–æ–ª–æ–¥–Ω–æ–π –≤—ã—Å–∞–¥–∫–∏ –º–µ—Ç–∏–∑–æ–≤"
‚úÖ "–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –¥–ª—è —Ö–æ–ª–æ–¥–Ω–æ–π –≤—ã—Å–∞–¥–∫–∏"
‚úÖ "–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ö–æ–ª–æ–¥–Ω–æ–π –≤—ã—Å–∞–¥–∫–∏"
‚úÖ "–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≤ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ –∫—Ä–µ–ø–µ–∂–∞"
‚úÖ "–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –≥–æ—Ä—è—á–µ–π —à—Ç–∞–º–ø–æ–≤–∫–æ–π"

–°–æ–∑–¥–∞–π –ø–ª–∞–Ω —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤. –ï—Å–ª–∏ –Ω–µ –º–æ–∂–µ—à—å –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å, —Å–∫–∞–∂–∏ –æ–± —ç—Ç–æ–º."""

        messages = [
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": user_prompt}
        ]

        response = await self._call_openai(
            messages=messages,
            temperature=temperature or 0.3,
            max_tokens=max_tokens or 3000,  # –£–≤–µ–ª–∏—á–∏–ª–∏ –¥–ª—è –ª—É—á—à–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
            model=self.plan_model  # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º gpt-4o
        )
        
        print(f"üìù –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç OpenAI: {len(response)} —Å–∏–º–≤–æ–ª–æ–≤")
        print(f"üîç –ü–µ—Ä–≤—ã–µ 200 —Å–∏–º–≤–æ–ª–æ–≤ –æ—Ç–≤–µ—Ç–∞: {response[:200]}...")

        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–ª–∞–Ω –∫–∞–∫ –µ—Å—Ç—å
        return {
            "plan_text": response,
            "format": "text"
        }

    async def generate_article_from_chunks(self, chunks: List[str], topic: str, 
                                         target_length: str = "medium",
                                         system_prompt: str = None,
                                         user_prompt: str = None,
                                         temperature: float = None,
                                         max_tokens: int = None,
                                         model: str = None) -> GeneratedArticle:
        """
        –û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–ª–Ω–æ–π —Å—Ç–∞—Ç—å–∏ –∏–∑ —á–∞–Ω–∫–æ–≤
        
        Args:
            chunks: –°–ø–∏—Å–æ–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —á–∞–Ω–∫–æ–≤
            topic: –¢–µ–º–∞ —Å—Ç–∞—Ç—å–∏  
            target_length: –¶–µ–ª–µ–≤–∞—è –¥–ª–∏–Ω–∞ ("short", "medium", "long")
        """
        print(f"ü§ñ –ù–∞—á–∏–Ω–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —Å—Ç–∞—Ç—å–∏ –ø–æ —Ç–µ–º–µ: {topic}")
        print(f"üìä –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞–Ω–∫–æ–≤: {len(chunks)}")
        
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —á–∞–Ω–∫–æ–≤ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
        print("üîÑ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —á–∞–Ω–∫–∏ —á–µ—Ä–µ–∑ GPT...")
        processed_chunks = []
        
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–ª–∏ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ
        current_system_prompt = system_prompt or self.system_prompt
        current_user_prompt = user_prompt or self.user_prompt
        current_temperature = temperature or self.temperature
        current_max_tokens = max_tokens or self.max_tokens
        current_model = model or self.model
        
        for i, chunk in enumerate(chunks):
            print(f"  üìù –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —á–∞–Ω–∫ {i+1}/{len(chunks)}")
            processed_chunk = await self.process_chunk_with_settings(
                chunk, topic, current_system_prompt, current_user_prompt, 
                current_temperature, current_max_tokens, current_model
            )
            processed_chunks.append(processed_chunk)
            
            # –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
            await asyncio.sleep(1)
        
        # –û–±—ä–µ–¥–∏–Ω—è–µ–º –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —á–∞–Ω–∫–∏
        full_content = "\n\n".join(processed_chunks)
        
        print("üé® –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º SEO-—ç–ª–µ–º–µ–Ω—Ç—ã...")
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º SEO-—ç–ª–µ–º–µ–Ω—Ç—ã –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
        tasks = [
            self.generate_title(full_content, topic),
            self.generate_h1(full_content, topic),
            self.generate_meta_description(full_content, topic),
            self.generate_keywords(full_content, topic)
        ]
        
        title, h1, meta_description, keywords = await asyncio.gather(*tasks)
        
        # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        word_count = len(full_content.split())
        
        article = GeneratedArticle(
            title=title,
            h1=h1,
            content=full_content,
            meta_description=meta_description,
            keywords=keywords,
            word_count=word_count,
            source_chunks_count=len(chunks)
        )
        
        print(f"‚úÖ –°—Ç–∞—Ç—å—è —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞: {word_count} —Å–ª–æ–≤")
        print(f"üì∞ –ó–∞–≥–æ–ª–æ–≤–æ–∫: {title}")
        print(f"üîë –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞: {keywords}")
        
        return article

    async def generate_full_article_from_plan(self, plan_text: str, keywords: List[str], target_length_chars: int, 
                                            system_prompt: str = None, temperature: float = None,
                                            additional_keywords: str = "", lsi_keywords: str = "", target_phrases: str = "",
                                            keyword_density: float = 2.5, seo_prompt: str = "", writing_style: str = "technical",
                                            content_type: str = "educational", target_audience: str = "specialists",
                                            heading_type: str = "h2", paragraph_length: str = "medium",
                                            use_lists: bool = True, internal_links: bool = False) -> GeneratedArticle:
        """
        –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–ª–Ω–æ–π —Å—Ç–∞—Ç—å–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–ª–∞–Ω–∞ (—ç—Ç–∞–ª–æ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∏–∑ Jupyter Notebook)
        """
        print(f"ü§ñ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ç–∞—Ç—å–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–ª–∞–Ω–∞: {target_length_chars} —Å–∏–º–≤–æ–ª–æ–≤")
        print(f"üîë –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞: {keywords}")
        
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É —Ç–æ—á–Ω–æ –∫–∞–∫ –≤ —ç—Ç–∞–ª–æ–Ω–Ω–æ–π –ª–æ–≥–∏–∫–µ (0.5)
        current_temperature = temperature or 0.5
        print(f"üå°Ô∏è –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: {current_temperature}")
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
        keyword_list = ', '.join(keywords)
        
        # –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
        all_keywords = keywords.copy()
        if additional_keywords:
            additional_list = [kw.strip() for kw in additional_keywords.split(',') if kw.strip()]
            all_keywords.extend(additional_list)
        
        # –î–æ–±–∞–≤–ª—è–µ–º LSI-–∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
        if lsi_keywords:
            lsi_list = [kw.strip() for kw in lsi_keywords.split(',') if kw.strip()]
            all_keywords.extend(lsi_list)
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Ü–µ–ª–µ–≤—ã–µ —Ñ—Ä–∞–∑—ã
        if target_phrases:
            phrases_list = [phrase.strip() for phrase in target_phrases.split(',') if phrase.strip()]
            all_keywords.extend(phrases_list)
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
        full_keyword_list = ', '.join(all_keywords)
        
        print(f"üîë –û—Å–Ω–æ–≤–Ω—ã–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞: {keyword_list}")
        print(f"üîë –ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤: {full_keyword_list}")
        print(f"üìä –ü–ª–æ—Ç–Ω–æ—Å—Ç—å –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤: {keyword_density}%")
        print(f"‚úçÔ∏è –°—Ç–∏–ª—å –Ω–∞–ø–∏—Å–∞–Ω–∏—è: {writing_style}")
        print(f"üìù –¢–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞: {content_type}")
        print(f"üë• –¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è: {target_audience}")
        
        # –ù–û–í–´–ô –ü–û–î–•–û–î: –ü–æ—ç—Ç–∞–ø–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–º –∫–æ–Ω—Ç—Ä–æ–ª–µ–º –¥–ª–∏–Ω—ã
        print(f"üîÑ –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ—ç—Ç–∞–ø–Ω—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è {target_length_chars} —Å–∏–º–≤–æ–ª–æ–≤")
        
        # –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π —Ä–∞—Å—á–µ—Ç —Ç–æ–∫–µ–Ω–æ–≤ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ü–µ–ª–µ–≤–æ–π –¥–ª–∏–Ω—ã
        if target_length_chars <= 5000:
            token_coefficient = 0.5
        elif target_length_chars <= 8000:
            token_coefficient = 0.6
        else:
            token_coefficient = 0.7  # –î–ª—è –¥–ª–∏–Ω–Ω—ã—Ö —Å—Ç–∞—Ç–µ–π —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç
        
        estimated_tokens = max(3000, int(target_length_chars * token_coefficient))
        print(f"üéØ –†–∞—Å—á–µ—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤: {estimated_tokens} (–∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç: {token_coefficient})")
        
        # –≠—Ç–∞–ø 1: –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –±–∞–∑–æ–≤—É—é —Å—Ç–∞—Ç—å—é —Å SEO-–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –∏–ª–∏ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π
        current_system_prompt = system_prompt or "–¢—ã ‚Äî –æ–ø—ã—Ç–Ω—ã–π —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π SEO-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –∏ –∫–æ–ø–∏—Ä–∞–π—Ç–µ—Ä. –ù–∞–ø–∏—à–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ SEO-–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å—Ç–∞—Ç—å—é –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–ª–∞–Ω–∞. –ò—Å–ø–æ–ª—å–∑—É–π –±–æ–ª—å—à–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–∫—Ç–æ–≤ –∏ —Ü–∏—Ñ—Ä. –°–æ–∑–¥–∞–π —Å—Ç–∞—Ç—å—é —Å –≥–ª—É–±–æ–∫–æ–π —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π: –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ (H1-H6), –æ–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –ø–ª–æ—Ç–Ω–æ—Å—Ç—å –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤, —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∞—è —Ä–∞–∑–º–µ—Ç–∫–∞, –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –ø–µ—Ä–µ–ª–∏–Ω–∫–æ–≤–∫–∞. –§–æ–∫—É—Å –Ω–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–º SEO –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ —á–∏—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç–∏."
        
        base_prompt = f"""
{current_system_prompt}

üîπ SEO-–¢–†–ï–ë–û–í–ê–ù–ò–Ø:
- –ò—Å–ø–æ–ª—å–∑—É–π –í–°–ï –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞: {full_keyword_list}
- –ü–ª–æ—Ç–Ω–æ—Å—Ç—å –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤: {keyword_density}%
- –°—Ç–∏–ª—å –Ω–∞–ø–∏—Å–∞–Ω–∏—è: {writing_style}
- –¢–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞: {content_type}
- –¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è: {target_audience}
- –¢–∏–ø –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤: {heading_type}
- –î–ª–∏–Ω–∞ –∞–±–∑–∞—Ü–µ–≤: {paragraph_length}
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ø–∏—Å–∫–∏: {'–î–∞' if use_lists else '–ù–µ—Ç'}
- –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Å—Å—ã–ª–∫–∏: {'–î–∞' if internal_links else '–ù–µ—Ç'}

üîπ –°–¢–†–£–ö–¢–£–†–ù–´–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø:
- –ö–∞–∂–¥—ã–π —Ä–∞–∑–¥–µ–ª –ø–ª–∞–Ω–∞ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º {max(1000, target_length_chars // 8)} —Å–∏–º–≤–æ–ª–æ–≤
- –î–æ–±–∞–≤–ª—è–π –¥–µ—Ç–∞–ª–∏, –ø—Ä–∏–º–µ—Ä—ã, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
- –í–∫–ª—é—á–∞–π –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏ —Å–æ–≤–µ—Ç—ã
- –î–æ–±–∞–≤–ª—è–π —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∏ –∞–Ω–∞–ª–∏–∑ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤

üîπ –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ô SEO-–ü–†–û–ú–ü–¢:
{seo_prompt if seo_prompt else "üîπ –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–ê–Ø SEO-–û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø –î–õ–Ø –¢–ï–•–ù–ò–ß–ï–°–ö–û–ì–û –ö–û–ù–¢–ï–ù–¢–ê:\n- –°–æ–∑–¥–∞–≤–∞–π —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç —Å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º–∏ –¥–µ—Ç–∞–ª—è–º–∏ –∏ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è–º–∏\n- –í–∫–ª—é—á–∞–π —á–∏—Å–ª–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ, –ø–∞—Ä–∞–º–µ—Ç—Ä—ã, —Å—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏\n- –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—É—é —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—é –∏ –æ—Ç—Ä–∞—Å–ª–µ–≤—ã–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—ã\n- –î–æ–±–∞–≤–ª—è–π –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∫–µ–π—Å—ã, –ø—Ä–∏–º–µ—Ä—ã –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è, —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è\n- –í–∫–ª—é—á–∞–π —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏, –∏–Ω–Ω–æ–≤–∞—Ü–∏–∏ –∏ —Ç—Ä–µ–Ω–¥—ã —Ä–∞–∑–≤–∏—Ç–∏—è\n- –°–æ–∑–¥–∞–≤–∞–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç —Å –ª–æ–≥–∏—á–µ—Å–∫–æ–π –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é\n- –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π –¥–ª—è –ø–æ–∏—Å–∫–æ–≤—ã—Ö —Å–∏—Å—Ç–µ–º —Å –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º –≤—Ö–æ–∂–¥–µ–Ω–∏–µ–º –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤\n- –í–∫–ª—é—á–∞–π LSI-–∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –∏ —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã\n- –î–æ–±–∞–≤–ª—è–π –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Å—Å—ã–ª–∫–∏ –∏ —Å—Å—ã–ª–∫–∏ –Ω–∞ –∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏\n- –°–æ–∑–¥–∞–≤–∞–π –∫–æ–Ω—Ç–µ–Ω—Ç, –æ—Ç–≤–µ—á–∞—é—â–∏–π –Ω–∞ –ø–æ–∏—Å–∫–æ–≤—ã–µ –Ω–∞–º–µ—Ä–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"}

üîπ –ü–ª–∞–Ω —Å—Ç–∞—Ç—å–∏:
{plan_text}

üîπ –ù–∞–ø–∏—à–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ SEO-–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å—Ç–∞—Ç—å—é, –∏—Å–ø–æ–ª—å–∑—É—è –≤—Å–µ —É–∫–∞–∑–∞–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:
"""
        
        print("üìù –≠—Ç–∞–ø 1: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –±–∞–∑–æ–≤–æ–π —Å—Ç–∞—Ç—å–∏...")
        base_response = await self._call_openai(
            messages=[{"role": "user", "content": base_prompt}],
            temperature=current_temperature,
            max_tokens=estimated_tokens,
            model="gpt-4o"
        )
        
        base_length = len(base_response)
        print(f"üìè –ë–∞–∑–æ–≤–∞—è —Å—Ç–∞—Ç—å—è: {base_length} —Å–∏–º–≤–æ–ª–æ–≤")
        
        # –≠—Ç–∞–ø 2: –ï—Å–ª–∏ –±–∞–∑–æ–≤–∞—è —Å—Ç–∞—Ç—å—è –∫–æ—Ä–æ—Ç–∫–∞—è, —Ä–∞—Å—à–∏—Ä—è–µ–º –µ—ë
        if base_length < target_length_chars * 0.8:  # –ï—Å–ª–∏ –º–µ–Ω—å—à–µ 80% –æ—Ç —Ü–µ–ª–∏
            print("üìù –≠—Ç–∞–ø 2: –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∫–æ—Ä–æ—Ç–∫–æ–π —Å—Ç–∞—Ç—å–∏...")
            
            expansion_prompt = f"""
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –†–ê–°–®–ò–†–ò–¢–¨ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é SEO-–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å—Ç–∞—Ç—å—é –¥–æ {target_length_chars} —Å–∏–º–≤–æ–ª–æ–≤.

üîπ –¢–ï–ö–£–©–ê–Ø –°–¢–ê–¢–¨–Ø ({base_length} —Å–∏–º–≤–æ–ª–æ–≤):
{base_response}

üîπ SEO-–¢–†–ï–ë–û–í–ê–ù–ò–Ø –†–ê–°–®–ò–†–ï–ù–ò–Ø:
- –ò—Å–ø–æ–ª—å–∑—É–π –í–°–ï –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞: {full_keyword_list}
- –ü–ª–æ—Ç–Ω–æ—Å—Ç—å –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤: {keyword_density}%
- –°—Ç–∏–ª—å –Ω–∞–ø–∏—Å–∞–Ω–∏—è: {writing_style}
- –¢–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞: {content_type}
- –¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è: {target_audience}
- –¢–∏–ø –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤: {heading_type}
- –î–ª–∏–Ω–∞ –∞–±–∑–∞—Ü–µ–≤: {paragraph_length}
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ø–∏—Å–∫–∏: {'–î–∞' if use_lists else '–ù–µ—Ç'}
- –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Å—Å—ã–ª–∫–∏: {'–î–∞' if internal_links else '–ù–µ—Ç'}

üîπ –°–¢–†–£–ö–¢–£–†–ù–´–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø –†–ê–°–®–ò–†–ï–ù–ò–Ø:
- –î–û–ë–ê–í–¨ {target_length_chars - base_length} —Å–∏–º–≤–æ–ª–æ–≤ –∫ —Å—Ç–∞—Ç—å–µ
- –ù–ï –∏–∑–º–µ–Ω—è–π —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç
- –†–ê–°–®–ò–†–¨ –∫–∞–∂–¥—ã–π —Ä–∞–∑–¥–µ–ª –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ –¥–µ—Ç–∞–ª—è–º–∏
- –î–æ–±–∞–≤—å –±–æ–ª—å—à–µ –ø—Ä–∏–º–µ—Ä–æ–≤, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫, –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö —Å–æ–≤–µ—Ç–æ–≤
- –í–∫–ª—é—á–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É, —Å—Ä–∞–≤–Ω–µ–Ω–∏—è, –∫–µ–π—Å—ã –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è
- –°–æ—Ö—Ä–∞–Ω–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏ –ª–æ–≥–∏–∫—É

üîπ –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ô SEO-–ü–†–û–ú–ü–¢:
{seo_prompt if seo_prompt else "üîπ –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–ê–Ø SEO-–û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø –î–õ–Ø –¢–ï–•–ù–ò–ß–ï–°–ö–û–ì–û –ö–û–ù–¢–ï–ù–¢–ê:\n- –°–æ–∑–¥–∞–≤–∞–π —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç —Å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º–∏ –¥–µ—Ç–∞–ª—è–º–∏ –∏ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è–º–∏\n- –í–∫–ª—é—á–∞–π —á–∏—Å–ª–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ, –ø–∞—Ä–∞–º–µ—Ç—Ä—ã, —Å—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏\n- –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—É—é —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—é –∏ –æ—Ç—Ä–∞—Å–ª–µ–≤—ã–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—ã\n- –î–æ–±–∞–≤–ª—è–π –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∫–µ–π—Å—ã, –ø—Ä–∏–º–µ—Ä—ã –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è, —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è\n- –í–∫–ª—é—á–∞–π —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏, –∏–Ω–Ω–æ–≤–∞—Ü–∏–∏ –∏ —Ç—Ä–µ–Ω–¥—ã —Ä–∞–∑–≤–∏—Ç–∏—è\n- –°–æ–∑–¥–∞–≤–∞–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç —Å –ª–æ–≥–∏—á–µ—Å–∫–æ–π –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é\n- –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π –¥–ª—è –ø–æ–∏—Å–∫–æ–≤—ã—Ö —Å–∏—Å—Ç–µ–º —Å –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º –≤—Ö–æ–∂–¥–µ–Ω–∏–µ–º –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤\n- –í–∫–ª—é—á–∞–π LSI-–∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –∏ —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã\n- –î–æ–±–∞–≤–ª—è–π –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Å—Å—ã–ª–∫–∏ –∏ —Å—Å—ã–ª–∫–∏ –Ω–∞ –∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏\n- –°–æ–∑–¥–∞–≤–∞–π –∫–æ–Ω—Ç–µ–Ω—Ç, –æ—Ç–≤–µ—á–∞—é—â–∏–π –Ω–∞ –ø–æ–∏—Å–∫–æ–≤—ã–µ –Ω–∞–º–µ—Ä–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"}

üîπ –†–ê–°–®–ò–†–ï–ù–ù–ê–Ø SEO-–û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–ê–Ø –°–¢–ê–¢–¨–Ø ({target_length_chars} —Å–∏–º–≤–æ–ª–æ–≤):
"""
            
            expansion_tokens = int(estimated_tokens * 1.2)  # –ë–æ–ª—å—à–µ —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
            expansion_response = await self._call_openai(
                messages=[{"role": "user", "content": expansion_prompt}],
                temperature=current_temperature,
                max_tokens=expansion_tokens,
                model="gpt-4o"
            )
            
            response = expansion_response
            actual_length = len(response)
            print(f"üìè –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å—Ç–∞—Ç—å—è: {actual_length} —Å–∏–º–≤–æ–ª–æ–≤")
            
        else:
            response = base_response
            actual_length = base_length

        print("üîÑ –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —Å—Ç–∞—Ç—å–∏...")
        print(f"üìÑ –î–ª–∏–Ω–∞ –ø–ª–∞–Ω–∞: {len(plan_text)} —Å–∏–º–≤–æ–ª–æ–≤")
        
        # –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏–Ω—ã
        target_min = int(target_length_chars * 0.8)  # -20% (–±–æ–ª–µ–µ –º—è–≥–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è)
        target_max = int(target_length_chars * 1.2)  # +20%
        
        print(f"üìè –§–∏–Ω–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ —Å—Ç–∞—Ç—å–∏: {actual_length} —Å–∏–º–≤–æ–ª–æ–≤ (—Ü–µ–ª—å: {target_length_chars})")
        print(f"üìè –î–æ–ø—É—Å—Ç–∏–º—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω: {target_min} - {target_max} —Å–∏–º–≤–æ–ª–æ–≤")
        
        if actual_length < target_min:
            deficit = target_length_chars - actual_length
            print(f"‚ö†Ô∏è –°—Ç–∞—Ç—å—è –≤—Å–µ –µ—â–µ –∫–æ—Ä–æ—Ç–∫–∞—è! –ù–µ–¥–æ—Å—Ç–∞—Ç–æ–∫: {deficit} —Å–∏–º–≤–æ–ª–æ–≤ ({(deficit / target_length_chars * 100):.1f}%)")
        elif actual_length > target_max:
            excess = actual_length - target_length_chars
            print(f"‚ö†Ô∏è –°—Ç–∞—Ç—å—è —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–∞—è! –ò–∑–±—ã—Ç–æ–∫: {excess} —Å–∏–º–≤–æ–ª–æ–≤ ({(excess / target_length_chars * 100):.1f}%)")
        else:
            print(f"‚úÖ –î–ª–∏–Ω–∞ —Å—Ç–∞—Ç—å–∏ –≤ –¥–æ–ø—É—Å—Ç–∏–º—ã—Ö –ø—Ä–µ–¥–µ–ª–∞—Ö")
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º SEO-—ç–ª–µ–º–µ–Ω—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–ª—É—á–µ–Ω–Ω–æ–π —Å—Ç–∞—Ç—å–∏
        title = await self.generate_title(response, "—Å—Ç–∞—Ç—å—è")
        h1 = await self.generate_h1(response, "—Å—Ç–∞—Ç—å—è")
        meta_description = await self.generate_meta_description(response, "—Å—Ç–∞—Ç—å—è")
        keywords_str = await self.generate_keywords(response, "—Å—Ç–∞—Ç—å—è")
        
        # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        word_count = len(response.split())
        
        article = GeneratedArticle(
            title=title,
            h1=h1,
            content=response,
            meta_description=meta_description,
            keywords=keywords_str,
            word_count=word_count,
            source_chunks_count=0  # –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º —á–∞–Ω–∫–∏ –≤ —ç—Ç–æ–º –º–µ—Ç–æ–¥–µ
        )
        
        print(f"‚úÖ –°—Ç–∞—Ç—å—è —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞: {word_count} —Å–ª–æ–≤, {actual_length} —Å–∏–º–≤–æ–ª–æ–≤")
        return article