# 🚀 ИНСТРУКЦИЯ ДЛЯ ЗАЛИВКИ TRIVE AI COPYWRITER НА СЕРВЕР

## 📋 ОБЩАЯ ИНФОРМАЦИЯ

**Репозиторий:** https://github.com/ashvidkov/trive-ai-copywriter-etap2.git  
**Дата обновления:** 06.08.2025  
**Версия:** Этап 2 - SEO интеграция + локальное сохранение + обновленная админка

---

## 🎯 КЛЮЧЕВЫЕ ИЗМЕНЕНИЯ В ПРОЕКТЕ

### ✅ НОВАЯ ФУНКЦИОНАЛЬНОСТЬ

#### 1. **SEO-интеграция с text.ru API** 🔍
- **Файлы:** `ai_backend2/text_ru_service.py`, `ai_backend2/seo_router.py`
- **Функции:** Проверка уникальности, водности, спама, ключевых слов
- **API ключ:** `ff355ac3b34a87295a0b78617a407477`
- **Эндпоинт:** `POST /seo/check-seo-quality`

#### 2. **SEO-функциональность на фронтенде** 🎨
- **Страницы:** `CreatePage.jsx`, `EditorPage.jsx`, `EditorPageMod.jsx`
- **Кнопка:** "Проверить SEO-параметры текста"
- **Отображение:** Карточки с метриками, цветовые индикаторы, топ-7 ключевых слов

#### 3. **Локальное сохранение текста** 💾
- **Технология:** `localStorage` для предотвращения потери данных
- **Функции:** Автосохранение при изменении, восстановление при загрузке
- **Очистка:** После успешного сохранения в базу данных

#### 4. **Обновленная логика тематик** 🏷️
- **Страницы:** `CreatePage.jsx`, `EditorPage.jsx`, `EditorPageMod.jsx`
- **Изменения:**
  - Разделение тематик на "для AI уникализации" и "для сохранения в БД"
  - Отдельные блоки выбора тематик с визуальным разделением
  - Улучшенная валидация при сохранении
  - Индикаторы выбранных тематик с количеством

#### 5. **Полностью обновленная админка** 👨‍💼
- **Новый интерфейс:** Современный дизайн с улучшенной навигацией
- **Функциональность:** Управление пользователями, тематиками, статьями
- **Безопасность:** Улучшенная система прав доступа

#### 6. **Исправления и улучшения** 🔧
- Убраны избыточные логи в терминале
- Исправлено перенаправление после сохранения
- Улучшена обработка ошибок
- Обновлена структура таблицы `themes` в БД

---

## 🏗️ АРХИТЕКТУРА ПРОЕКТА

### **Сервисы и порты (АДАПТИРОВАТЬ ПОД СЕРВЕР):**
- **Frontend (React):** Использовать существующий порт сервера
- **Основной Backend (Node.js):** Использовать существующий порт сервера
- **AI Backend (FastAPI):** Настроить новый порт для ai_backend2

### **Ключевые файлы:**
```
ai_backend2/
├── main.py                 # Основной FastAPI сервер
├── start_seo_server.py     # Скрипт запуска SEO сервера
├── text_ru_service.py      # Интеграция с text.ru API
├── seo_router.py           # SEO API эндпоинты
├── openai_service.py       # OpenAI интеграция
├── search_service.py       # Поиск через Яндекс API
├── content_parser.py       # Парсинг контента
├── content_cleaner.py      # Очистка контента
├── text_chunker.py         # Разбивка на чанки
├── yandex_auth.py          # Яндекс авторизация
└── requirements.txt        # Зафиксированные зависимости

frontend/src/pages/
├── SeoSearchPage.jsx       # Основная страница SEO-копирайтера
├── CreatePage.jsx          # Создание статьи + SEO + тематики
├── EditorPage.jsx          # Редактирование + SEO + тематики
└── EditorPageMod.jsx       # Расширенное редактирование + SEO + тематики

backend/
├── app.js                  # Основной Express сервер
├── routers/                # API маршруты
└── services/               # Бизнес-логика
```

---

## 🔧 ИНСТРУКЦИЯ ПО ЗАЛИВКЕ НА СЕРВЕР

### **ШАГ 1: Подготовка сервера**

```bash
# Подключение к серверу
ssh root@your-server-ip

# Переход в директорию проекта
cd /root/ai_copywright_trive

# Остановка текущих сервисов (ИСПОЛЬЗОВАТЬ СУЩЕСТВУЮЩИЕ КОМАНДЫ)
sudo systemctl stop trive-backend
sudo systemctl stop trive-frontend
# НЕ ОСТАНАВЛИВАТЬ trive-ai-backend (если есть) - заменим его

# Создание резервной копии
cp -r . ../ai_copywright_trive_backup_$(date +%Y%m%d_%H%M%S)
```

### **ШАГ 2: Обновление кода**

```bash
# Очистка только ai_backend2 (остальное оставить как есть)
rm -rf ai_backend2/*

# Клонирование/обновление из репозитория
git clone https://github.com/ashvidkov/trive-ai-copywriter-etap2.git temp_repo

# Копирование только ai_backend2
cp -r temp_repo/ai_backend2/* ai_backend2/

# Копирование обновленных страниц фронтенда
cp -r temp_repo/frontend/src/pages/* frontend/src/pages/

# Очистка временных файлов
rm -rf temp_repo
```

### **ШАГ 3: Установка зависимостей ТОЛЬКО для ai_backend2**

```bash
# Python зависимости для ai_backend2
cd ai_backend2
pip install -r requirements.txt

# ПРОВЕРИТЬ что все зависимости установлены
pip list | grep -E "(fastapi|uvicorn|openai|requests|beautifulsoup4)"
```

### **ШАГ 4: Настройка переменных окружения**

```bash
# ПРОВЕРИТЬ существующие .env файлы (НЕ ИЗМЕНЯТЬ)
cd /root/ai_copywright_trive

# Проверить backend/.env (оставить как есть)
cat backend/.env

# ДОБАВИТЬ в ai_backend2/.env только новые переменные:
cat >> ai_backend2/.env << EOF
TEXT_RU_API_KEY=ff355ac3b34a87295a0b78617a407477
EOF

# ПРОВЕРИТЬ что OPENAI_API_KEY уже есть в ai_backend2/.env
cat ai_backend2/.env | grep OPENAI_API_KEY
```

### **ШАГ 5: Настройка порта для ai_backend2**

```bash
# ОПРЕДЕЛИТЬ свободный порт на сервере
netstat -tlnp | grep LISTEN

# РЕКОМЕНДУЕМЫЙ порт: 8002 (если свободен)
# Если 8002 занят, выбрать другой свободный порт

# Обновить start_seo_server.py если нужно изменить порт
# nano ai_backend2/start_seo_server.py
# Изменить строку: port=8002 на нужный порт
```

### **ШАГ 6: Обновление systemd сервиса для ai_backend2**

```bash
# Обновление сервиса для ai_backend2
sudo tee /etc/systemd/system/trive-ai-backend.service > /dev/null << 'EOF'
[Unit]
Description=TRIVE AI Backend (SEO + OpenAI)
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/root/ai_copywright_trive/ai_backend2
ExecStart=/usr/bin/python3 start_seo_server.py
Restart=always
RestartSec=10
Environment=NODE_ENV=production
Environment=PYTHONPATH=/root/ai_copywright_trive/ai_backend2

[Install]
WantedBy=multi-user.target
EOF

# Перезагрузка systemd
sudo systemctl daemon-reload
```

### **ШАГ 7: Запуск сервисов**

```bash
# Запуск ai_backend2 (новый сервис)
sudo systemctl start trive-ai-backend

# Перезапуск существующих сервисов (ИСПОЛЬЗОВАТЬ СУЩЕСТВУЮЩИЕ КОМАНДЫ)
sudo systemctl restart trive-backend
sudo systemctl restart trive-frontend

# Проверка статуса
sudo systemctl status trive-backend
sudo systemctl status trive-frontend
sudo systemctl status trive-ai-backend

# Включение автозапуска
sudo systemctl enable trive-ai-backend
```

### **ШАГ 8: Проверка работоспособности**

```bash
# Проверка портов (адаптировать под порты сервера)
netstat -tlnp | grep -E ':(4000|5173|8002)'  # или другие порты сервера

# Проверка логов
sudo journalctl -u trive-ai-backend -f
sudo journalctl -u trive-backend -f
sudo journalctl -u trive-frontend -f

# Тест API endpoints (адаптировать порты)
curl http://localhost:8002/health  # или другой порт ai_backend2
curl http://localhost:4000/health  # или другой порт backend
```

---

## 🧪 ТЕСТИРОВАНИЕ НОВОЙ ФУНКЦИОНАЛЬНОСТИ

### **1. SEO-проверка:**
```bash
# Тест SEO API (адаптировать порт)
curl -X POST http://localhost:8002/seo/check-seo-quality \
  -H "Content-Type: application/json" \
  -d '{"text": "Тестовый текст для проверки SEO параметров", "max_wait_time": 120}'
```

### **2. Проверка баланса text.ru:**
```bash
curl http://localhost:8002/seo/text-ru-balance
```

### **3. Тест фронтенда:**
- Открыть существующий URL сервера
- Перейти на страницу создания статьи
- Проверить новые блоки тематик:
  - "Тематики для AI уникализации"
  - "Тематики для сохранения записи в базе данных"
- Ввести текст и нажать "Проверить SEO-параметры текста"
- Проверить отображение результатов

### **4. Тест локального сохранения:**
- Ввести текст на любой странице
- Переключиться на другую вкладку
- Вернуться - текст должен восстановиться
- Сохранить в базу - локальное сохранение должно очиститься

---

## 🚨 ВОЗМОЖНЫЕ ПРОБЛЕМЫ И РЕШЕНИЯ

### **Проблема 1: Конфликт портов**
```bash
# Проверка занятых портов
netstat -tlnp | grep LISTEN

# Изменение порта в start_seo_server.py
nano ai_backend2/start_seo_server.py
# Изменить port=8002 на свободный порт
```

### **Проблема 2: Сервис ai_backend2 не запускается**
```bash
# Проверка логов
sudo journalctl -u trive-ai-backend -n 50

# Проверка зависимостей
cd /root/ai_copywright_trive/ai_backend2
pip list | grep -E "(fastapi|uvicorn|openai|requests)"

# Проверка .env файла
cat ai_backend2/.env
```

### **Проблема 3: Ошибки с text.ru API**
```bash
# Проверка баланса (адаптировать порт)
curl http://localhost:8002/seo/text-ru-balance

# Проверка API ключа в .env
cat ai_backend2/.env | grep TEXT_RU_API_KEY
```

### **Проблема 4: Фронтенд не отображает новые функции**
```bash
# Проверка консоли браузера
# Проверка CORS настроек
# Проверка доступности API на новом порту
```

### **Проблема 5: Ошибки с тематиками**
```bash
# Проверка структуры БД themes
# Проверка API эндпоинтов тематик
# Проверка фронтенд логики выбора тематик
```

---

## 📊 МОНИТОРИНГ И ЛОГИ

### **Просмотр логов в реальном времени:**
```bash
# AI Backend логи
sudo journalctl -u trive-ai-backend -f

# Основной Backend логи
sudo journalctl -u trive-backend -f

# Frontend логи
sudo journalctl -u trive-frontend -f
```

### **Проверка использования ресурсов:**
```bash
# Использование памяти и CPU
htop

# Использование диска
df -h

# Сетевые соединения
netstat -tlnp
```

---

## 🔄 ОТКАТ ПРИ ПРОБЛЕМАХ

```bash
# Остановка только нового сервиса
sudo systemctl stop trive-ai-backend

# Восстановление ai_backend2 из резервной копии
cd /root
cp -r ai_copywright_trive_backup_YYYYMMDD_HHMMSS/ai_backend2 ai_copywright_trive/

# Восстановление страниц фронтенда
cp -r ai_copywright_trive_backup_YYYYMMDD_HHMMSS/frontend/src/pages ai_copywright_trive/frontend/src/

# Перезапуск сервисов
sudo systemctl restart trive-backend trive-frontend
```

---

## ✅ ЧЕКЛИСТ ЗАВЕРШЕНИЯ

- [ ] ai_backend2 обновлен из репозитория
- [ ] Страницы фронтенда обновлены
- [ ] Зависимости ai_backend2 установлены
- [ ] .env файлы настроены (только новые переменные)
- [ ] Порт для ai_backend2 определен и настроен
- [ ] systemd сервис trive-ai-backend создан
- [ ] Все сервисы запущены и работают
- [ ] SEO-проверка работает
- [ ] Локальное сохранение работает
- [ ] Новая логика тематик работает
- [ ] Обновленная админка работает
- [ ] Логи не содержат критических ошибок
- [ ] Автозапуск сервисов включен

---

## 📝 ВАЖНЫЕ ЗАМЕЧАНИЯ

### **Порты:**
- Использовать существующие порты сервера для frontend и backend
- Настроить только новый порт для ai_backend2
- Проверить доступность портов перед настройкой

### **.env файлы:**
- НЕ изменять существующие .env файлы
- Добавить только новые переменные в ai_backend2/.env
- Сохранить все существующие API ключи

### **Зависимости:**
- Установить только новые зависимости для ai_backend2
- Не трогать существующие зависимости frontend и backend
- Использовать зафиксированные версии в requirements.txt

### **База данных:**
- Структура таблицы themes уже обновлена на сервере
- НЕ выполнять дополнительные SQL скрипты
- Проверить работу с тематиками после обновления

**📞 При возникновении проблем:**  
1. Проверить логи сервисов
2. Проверить доступность портов
3. Проверить переменные окружения
4. При необходимости - откатиться к резервной копии

**🎯 Цель:** Полностью функциональный TRIVE AI Copywriter с SEO-интеграцией, локальным сохранением и обновленной админкой на продакшн сервере. 